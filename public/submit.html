<html>

    <head>
        <title>Moscrop Secondary | Create Post</title>

        <!--Import materialize.css-->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.1/css/materialize.min.css">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

        <!--Let browser know website is optimized for mobile-->
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

        <link rel="stylesheet" href="css/quill.snow.css">
        <script src="js/quill.js"></script> 

        <link type="text/css" rel="stylesheet" href="css/common.css"/>
        <link type="text/css" rel="stylesheet" href="css/submit.css"/>

        <!-- Import Parse -->
        <script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.5.0.min.js"></script>
    </head>

    <body>
        
        <div id="navbar-container">
            <ul id="accountDropdownItems" class="dropdown-content">
                <li><a href="settings.html">Settings</a></li>
                <li><a onclick="logout()">Logout</a></li>
            </ul>
            <ul id="loggedInOverflowItems" class="dropdown-content">
                <li id="submitButton_overflow"><a href="submit.html">Submit</a></li>
                <li id="adminButton_overflow"><a href="administration.html">Admin</a></li>
                <li><a href="settings.html">Settings</a></li>
                <li><a onclick="logout()">Logout</a></li>
            </ul>
            <ul id="loggedOutOverflowItems" class="dropdown-content">
                <li><a href="login.html">Login</a></li>
                <li><a href="register.html">Register</a></li>
            </ul>
            <div class="navbar-fixed" style="height:72px">
                <nav>
                    <div class="nav-wrapper" style="background-color:#4784c0; padding-left:16px; padding-right:16px">
                        <a href="index.html" class="brand-logo">Moscrop Secondary</a>
                        <div id="toolbarActions" class="hidden">
                            <div id="loggedInActions">
                                <ul class="right hide-on-med-and-down">
                                    <li id="username" style="background-color:#4784c0; margin-right:16px"></li>
                                    <li id="submitButton"><a href="submit.html" class="tooltipped" data-position="bottom" data-delay="50" data-tooltip="Create new post"><i class="material-icons">create</i></a></li>
                                    <li id="adminButton"><a href="administration.html" class="tooltipped" data-position="bottom" data-delay="50" data-tooltip="Administration"><i class="material-icons">lock</i></a></li>
                                    <li id="accountDropdown"><a class="dropdown-button" href="#!" data-activates="accountDropdownItems"><i class="material-icons">account_circle</i></a></li>
                                </ul>   
                                <ul class="right hide-on-large-only">
                                    <li id="loggedInOverflow"><a class="dropdown-button" href="#!" data-activates="loggedInOverflowItems"><i class="material-icons">more_vert</i></a></li>
                                </ul>
                            </div>
                            <div id="loggedOutActions">
                                <ul class="right hide-on-med-and-down">
                                    <li id="loginButton"><a href="login.html">Login</a></li>
                                    <li id="registerButton"><a href="register.html">Register</a></li>
                                </ul>
                                <ul class="right hide-on-large-only">
                                    <li id="loggedOutOverflow"><a class="dropdown-button" href="#!" data-activates="loggedOutOverflowItems"><i class="material-icons">more_vert</i></a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </nav>
            </div>
        </div>

        <div class="container">
            <div class="row">
                <div class="input-field col s12">
                    <select id="tag_chooser">
                        <option value="">No categories available</option>
                    </select>
                    <label>Post as:</label>
              </div>
            </div>
        </div>

        <div id="toolbar" class="ql-toolbar-container toolbar">
            <span class="ql-format-group">
                <select title="Font" class="ql-font">
                    <option value="sans-serif" selected>Sans Serif</option>
                    <option value="serif">Serif</option>
                    <option value="monospace">Monospace</option>
                </select>
                <select title="Size" class="ql-size">
                    <option value="10px">Small</option>
                    <option value="13px" selected>Normal</option>
                    <option value="18px">Large</option>
                    <option value="32px">Huge</option>
                </select>
            </span>
            <span class="ql-format-group">
                <span title="Bold" class="ql-format-button ql-bold"></span>
                <span class="ql-format-separator"></span>
                <span title="Italic" class="ql-format-button ql-italic"></span>
                <span class="ql-format-separator"></span>
                <span title="Underline" class="ql-format-button ql-underline"></span>
                <span class="ql-format-separator"></span>
                <span title="Strikethrough" class="ql-format-button ql-strike"></span>
            </span>
            <span class="ql-format-group">
                <select title="Text Color" class="ql-color">
                    <option value="rgb(0, 0, 0)" label="rgb(0, 0, 0)" selected></option>
                    <option value="rgb(230, 0, 0)" label="rgb(230, 0, 0)"></option>
                    <option value="rgb(255, 153, 0)" label="rgb(255, 153, 0)"></option>
                    <option value="rgb(255, 255, 0)" label="rgb(255, 255, 0)"></option>
                    <option value="rgb(0, 138, 0)" label="rgb(0, 138, 0)"></option>
                    <option value="rgb(0, 102, 204)" label="rgb(0, 102, 204)"></option>
                    <option value="rgb(153, 51, 255)" label="rgb(153, 51, 255)"></option>
                    <option value="rgb(255, 255, 255)" label="rgb(255, 255, 255)"></option>
                    <option value="rgb(250, 204, 204)" label="rgb(250, 204, 204)"></option>
                    <option value="rgb(255, 235, 204)" label="rgb(255, 235, 204)"></option>
                    <option value="rgb(255, 255, 204)" label="rgb(255, 255, 204)"></option>
                    <option value="rgb(204, 232, 204)" label="rgb(204, 232, 204)"></option>
                    <option value="rgb(204, 224, 245)" label="rgb(204, 224, 245)"></option>
                    <option value="rgb(235, 214, 255)" label="rgb(235, 214, 255)"></option>
                    <option value="rgb(187, 187, 187)" label="rgb(187, 187, 187)"></option>
                    <option value="rgb(240, 102, 102)" label="rgb(240, 102, 102)"></option>
                    <option value="rgb(255, 194, 102)" label="rgb(255, 194, 102)"></option>
                    <option value="rgb(255, 255, 102)" label="rgb(255, 255, 102)"></option>
                    <option value="rgb(102, 185, 102)" label="rgb(102, 185, 102)"></option>
                    <option value="rgb(102, 163, 224)" label="rgb(102, 163, 224)"></option>
                    <option value="rgb(194, 133, 255)" label="rgb(194, 133, 255)"></option>
                    <option value="rgb(136, 136, 136)" label="rgb(136, 136, 136)"></option>
                    <option value="rgb(161, 0, 0)" label="rgb(161, 0, 0)"></option>
                    <option value="rgb(178, 107, 0)" label="rgb(178, 107, 0)"></option>
                    <option value="rgb(178, 178, 0)" label="rgb(178, 178, 0)"></option>
                    <option value="rgb(0, 97, 0)" label="rgb(0, 97, 0)"></option>
                    <option value="rgb(0, 71, 178)" label="rgb(0, 71, 178)"></option>
                    <option value="rgb(107, 36, 178)" label="rgb(107, 36, 178)"></option>
                    <option value="rgb(68, 68, 68)" label="rgb(68, 68, 68)"></option>
                    <option value="rgb(92, 0, 0)" label="rgb(92, 0, 0)"></option>
                    <option value="rgb(102, 61, 0)" label="rgb(102, 61, 0)"></option>
                    <option value="rgb(102, 102, 0)" label="rgb(102, 102, 0)"></option>
                    <option value="rgb(0, 55, 0)" label="rgb(0, 55, 0)"></option>
                    <option value="rgb(0, 41, 102)" label="rgb(0, 41, 102)"></option>
                    <option value="rgb(61, 20, 102)" label="rgb(61, 20, 102)"></option>
                </select>
                <span class="ql-format-separator"></span>
                <select title="Background Color" class="ql-background">
                    <option value="rgb(0, 0, 0)" label="rgb(0, 0, 0)"></option>
                    <option value="rgb(230, 0, 0)" label="rgb(230, 0, 0)"></option>
                    <option value="rgb(255, 153, 0)" label="rgb(255, 153, 0)"></option>
                    <option value="rgb(255, 255, 0)" label="rgb(255, 255, 0)"></option>
                    <option value="rgb(0, 138, 0)" label="rgb(0, 138, 0)"></option>
                    <option value="rgb(0, 102, 204)" label="rgb(0, 102, 204)"></option>
                    <option value="rgb(153, 51, 255)" label="rgb(153, 51, 255)"></option>
                    <option value="rgb(255, 255, 255)" label="rgb(255, 255, 255)" selected></option>
                    <option value="rgb(250, 204, 204)" label="rgb(250, 204, 204)"></option>
                    <option value="rgb(255, 235, 204)" label="rgb(255, 235, 204)"></option>
                    <option value="rgb(255, 255, 204)" label="rgb(255, 255, 204)"></option>
                    <option value="rgb(204, 232, 204)" label="rgb(204, 232, 204)"></option>
                    <option value="rgb(204, 224, 245)" label="rgb(204, 224, 245)"></option>
                    <option value="rgb(235, 214, 255)" label="rgb(235, 214, 255)"></option>
                    <option value="rgb(187, 187, 187)" label="rgb(187, 187, 187)"></option>
                    <option value="rgb(240, 102, 102)" label="rgb(240, 102, 102)"></option>
                    <option value="rgb(255, 194, 102)" label="rgb(255, 194, 102)"></option>
                    <option value="rgb(255, 255, 102)" label="rgb(255, 255, 102)"></option>
                    <option value="rgb(102, 185, 102)" label="rgb(102, 185, 102)"></option>
                    <option value="rgb(102, 163, 224)" label="rgb(102, 163, 224)"></option>
                    <option value="rgb(194, 133, 255)" label="rgb(194, 133, 255)"></option>
                    <option value="rgb(136, 136, 136)" label="rgb(136, 136, 136)"></option>
                    <option value="rgb(161, 0, 0)" label="rgb(161, 0, 0)"></option>
                    <option value="rgb(178, 107, 0)" label="rgb(178, 107, 0)"></option>
                    <option value="rgb(178, 178, 0)" label="rgb(178, 178, 0)"></option>
                    <option value="rgb(0, 97, 0)" label="rgb(0, 97, 0)"></option>
                    <option value="rgb(0, 71, 178)" label="rgb(0, 71, 178)"></option>
                    <option value="rgb(107, 36, 178)" label="rgb(107, 36, 178)"></option>
                    <option value="rgb(68, 68, 68)" label="rgb(68, 68, 68)"></option>
                    <option value="rgb(92, 0, 0)" label="rgb(92, 0, 0)"></option>
                    <option value="rgb(102, 61, 0)" label="rgb(102, 61, 0)"></option>
                    <option value="rgb(102, 102, 0)" label="rgb(102, 102, 0)"></option>
                    <option value="rgb(0, 55, 0)" label="rgb(0, 55, 0)"></option>
                    <option value="rgb(0, 41, 102)" label="rgb(0, 41, 102)"></option>
                    <option value="rgb(61, 20, 102)" label="rgb(61, 20, 102)"></option>
                </select>
            </span>
            <span class="ql-format-group">
                <span title="List" class="ql-format-button ql-list"></span>
                <span class="ql-format-separator"></span>
                <span title="Bullet" class="ql-format-button ql-bullet"></span>
                <span class="ql-format-separator"></span>
                <select title="Text Alignment" class="ql-align">
                    <option value="left" label="Left" selected></option>
                    <option value="center" label="Center"></option>
                    <option value="right" label="Right"></option>
                    <option value="justify" label="Justify"></option>
                </select>
            </span>
            <span class="ql-format-group">
                <span title="Link" class="ql-format-button ql-link"></span>
                <span class="ql-format-separator"></span>
                <span title="Image" class="ql-format-button ql-image"></span>
            </span>
        </div>

        <div id="title_field"></div>

        <div id="editor"></div>

        <div id="no_tags_warning_modal" class="modal">
            <div class="modal-content">
                <h4>No Categories</h4>
                <div class="container">
                    <div class="section">
                        <p>You don't belong to any category yet. Why not request to join one?</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a class="modal-action waves-effect waves-green btn-flat" href="settings.html">Take me there!</a>
                <a class="modal-action waves-effect waves-green btn-flat" href="index.html">No thanks</a>
            </div>
        </div>

        <div class="fixed-action-btn" style="bottom: 42px; right: 42px;">
            <a id="submit_fab" class="btn-floating btn-large waves-effect waves-light red" onclick="submitPost()">
                <i class="material-icons">send</i>
            </a>
        </div>

        <!--Import jQuery before materialize.js-->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.1/js/materialize.min.js"></script>
        <script>

            var submitted = false;

            // Page-specific init
            function init() {

                if (mUserTags.length == 0) {
                    $('#no_tags_warning_modal').openModal({
                        dismissible: false
                    });
                } else {

                    $('#tag_chooser').material_select();
                    refreshTagChooser();

                    var titleField = new Quill('#title_field', {
                        theme: 'snow'
                    });

                    var editor = new Quill('#editor', {
                        modules: {
                            'toolbar': {
                                container: '#toolbar'
                            },
                            'image-tooltip': true,
                            'link-tooltip': true
                        },
                        theme: 'snow'
                    });

                }
            }            

            function refreshTagChooser() {
                var select = document.getElementById('tag_chooser');
                select.innerHTML = "";
                $.each(
                    mUserTags,
                    function(i, category) {
                        var option = document.createElement("option");
                        option.value = category.getName();
                        option.innerHTML = category.getName();

                        select.appendChild(option);
                    }
                );
                $('#tag_chooser').material_select();
            }

            function getSelectedCategory() {
                var tagChooser = document.getElementById("tag_chooser");
                var selectedCategory = tagChooser.options[tagChooser.selectedIndex].value;
                if (selectedCategory) {
                    return selectedCategory;
                } else {
                    return null;
                }
            }

            function submitPost() {
                if (!submitted) {
                    var selectedCategory = getSelectedCategory();
                    if (selectedCategory) {
                        submitted = true;
                        var Post = Parse.Object.extend("Posts");
                        var roleQuery = new Parse.Query(Parse.Role);
                        roleQuery.equalTo("name", selectedCategory);
                        roleQuery.first().then(function(categoryRole) {
                            var query = new Parse.Query("Categories");
                            query.equalTo("name", selectedCategory);
                            query.first({
                                success: function(category) {
                                    var bloggerId = "0";
                                    var createdBy = currentUser;
                                    var title = cleanUpTitle(titleField.getText());
                                    var published = new Date();
                                    var updated = published;
                                    var content = editor.getHTML();
                                    var bgImage = getBgImage(content);

                                    var post = new Post();

                                    var acl = new Parse.ACL();
                                    acl.setPublicReadAccess(true);
                                    acl.setRoleWriteAccess(categoryRole, true);
                                    post.setACL(acl);

                                    post.save(
                                        {
                                            bloggerId: bloggerId,
                                            createdBy: createdBy,
                                            title: title,
                                            published: published,
                                            updated: updated,
                                            category: category,
                                            content: content,
                                            bgImage: bgImage
                                        }, {
                                            success: function(savedParsePost) {
                                                var fab = document.getElementById("submit_fab");
                                                fab.className = "btn-floating btn-large disabled";
                                                fab.onclick = null;
                                                Materialize.toast('Post successfully submitted', 4000, '', function() {
                                                    window.location.href = "index.html";        
                                                });
                                            },
                                            error: function(parsePost, error) {
                                                alert("Error: " + error.code + ", " + error.message);
                                                submitted = false;
                                            }
                                        }
                                    );      
                                },
                                error: function(category, error) {
                                    alert("error");
                                    submitted = false;
                                }
                            });
                        });
                    }
                }
            }

            function cleanUpTitle(title) {
                return title.replace(/ *\[[^\]]*]/g, "")        // Remove things within [stuff]
                        .replace(/[\[\]']+/g, "")               // Remove the [] that are leftover
                        .trim();                                // Remove leading and trailing white spaces
            }

            function getBgImage(content) {
                var regex = /src=\"([^\"]+)/g;
                var match= regex.exec(content);

                if (match !== null && match[1].indexOf("http") > -1) {
                    return match[1];
                } else {
                    return "@null";
                }
            }

            function logout() {
                Parse.User.logOut();
                currentUser = Parse.User.current();  // this will now be null
                window.location.href="index.html";
            }

        </script>
        <script src="js/common.js"></script>

    </body>

</html>
