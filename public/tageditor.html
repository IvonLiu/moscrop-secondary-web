<html>

    <head>
        <title>Moscrop Secondary | Admin</title>

        <!--Import materialize.css-->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.1/css/materialize.min.css">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

        <link type="text/css" rel="stylesheet" href="css/common.css"/>
        <link type="text/css" rel="stylesheet" href="css/tageditor.css"/>

        <!--Let biser know website is optimized for mobile-->
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

        <!-- Import Parse -->
        <script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.5.0.min.js"></script>
    </head>

    <body bgcolor="#eee">

        <div id="navbar-container">
            <ul id="accountDropdownItems" class="dropdown-content">
                <li><a href="settings.html">Settings</a></li>
                <!--<li class="divider"></li>-->
                <li><a onclick="logout()">Logout</a></li>
            </ul>
            <div class="navbar-fixed" style="height:72px">
                <nav>
                    <div class="nav-wrapper" style="background-color:#4784c0; padding-left:16px; padding-right:16px">
                        <a href="index.html" class="brand-logo">Moscrop Secondary</a>
                        <div id="toolbarActions" class="hidden">
                            <ul id="loggedInActions" class="right hide-on-med-and-down">
                                <li id="username" style="background-color:#4784c0; margin-right:16px"></li>
                                <li id="submitButton"><a href="submit.html"><i class="material-icons">create</i></a></li>
                                <li id="requestButton"><a href="#" onclick="openRequestModal()"><i class="material-icons">create</i></a></li>
                                <li id="adminButton"><a href="administration.html"><i class="material-icons">lock</i></a></li>
                                <li id="accountDropdown"><a class="dropdown-button" href="#!" data-activates="accountDropdownItems"><i class="material-icons">account_circle</i></a></li>
                            </ul>
                            <ul id="loggedOutActions" class="right hide-on-med-and-down">
                                <li id="loginButton"><a href="login.html">Login</a></li>
                                <li id="registerButton"><a href="register.html">Register</a></li>
                            </ul>
                        </div>
                    </div>
                </nav>
            </div>

            <div id="request_access_modal" class="modal modal-fixed-footer">
                <div class="modal-content">
                    <h4>Request Access</h4>
                    <div class="row">
                        <form id="available_categories" class="col s12" action="#"></form>
                    </div>
                    <div class="row">
                        <div class="input-field col s12" onkeydown="if (event.keyCode == 13) addClub()">
                            <i class="material-icons prefix">add</i>
                            <input id="request_new_club" type="text" class="validate">
                            <label for="request_new_club">Request new club</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <a class="modal-action waves-effect waves-green btn-flat" onclick="sendAccessRequest()">Request</a>
                    <a class="modal-action modal-close waves-effect waves-green btn-flat" href="#!">Cancel</a>
                </div>
            </div>
        </div>

        <!-- Tag grid container -->
        <div class="container">
            <div id="tag_list" class="row"></div>
            <div class="col s12">
                <a class="waves-effect waves-light btn" style="width:100%; margin-bottom:32px" onclick="exportTags()">Export tags</a>
            </div>
        </div>

        <!-- FAB -->
        <div class="fixed-action-btn" style="bottom: 42px; right: 42px;">
            <a class="btn-floating btn-large waves-effect waves-light red modal-trigger" href="#create_tag_modal">
                <i class="material-icons">add</i>
            </a>
        </div>

        <!-- Modal Structure -->
        <div id="create_tag_modal" class="modal modal-fixed-footer">
            <div class="modal-content">
                <h4>Create Tag</h4>
                <div class="row">
                    <form class="col s12">
                        <div class="row">    
                            <div class="input-field col s12">
                              <input id="name_field" type="text" class="validate">
                              <label for="name_field">Category Name</label>
                            </div>
                        </div>
                        <div class="row">    
                            <div class="input-field col s12">
                              <input id="id_author_field" type="text" class="validate">
                              <label for="id_author_field">Blogger Author</label>
                            </div>
                        </div>
                        <div class="row">    
                            <div class="input-field col s12">
                              <input id="id_category_field" type="text" class="validate">
                              <label for="id_category_field">Blogger Category</label>
                            </div>
                        </div>
                        <div class="row">    
                            <div class="input-field col s12">
                              <input id="icon_img_field" type="url" class="validate">
                              <label for="icon_img_field">Icon URL</label>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <a class="modal-action modal-close waves-effect waves-green btn-flat" href="#!">Cancel</a>
                <a class="modal-action waves-effect waves-green btn-flat" onclick="addTag()">Create</a>
            </div>
        </div>

        <div id="update_tag_modal" class="modal modal-fixed-footer">
            <div class="modal-content">

                <h4 id="update_tag_modal_title">Update Tag</h4>

                <div class="section">
                    <div class="container">
                        <h5>Tag Info</h5>
                        <div class="row">
                            <form class="col s12">
                                <div class="row">    
                                    <div class="input-field col s12">
                                      <input id="update_id_author_field" type="text" class="validate">
                                      <label id="update_id_author_field_label" for="update_id_author_field">Blogger Author</label>
                                    </div>
                                </div>
                                <div class="row">    
                                    <div class="input-field col s12">
                                      <input id="update_id_category_field" type="text" class="validate">
                                      <label id="update_id_category_field_label" for="update_id_category_field">Blogger Category</label>
                                    </div>
                                </div>
                                <div class="row">    
                                    <div class="input-field col s12">
                                      <input id="update_icon_img_field" type="url" class="validate">
                                      <label id="update_icon_img_field_label" for="update_icon_img_field">Icon URL</label>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="container">
                        <h5>Users in Tag:</h5>
                        <div id="users_in_tag"></div>
                        <div class="row">
                            <div class="input-field col s12" onkeydown="if (event.keyCode == 13) addUserToTag()">
                                <i class="material-icons prefix">add</i>
                                <input id="add_user_to_club" type="text" class="validate">
                                <label for="add_user_to_club">Add user to tag</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a class="modal-action modal-close waves-effect waves-green btn-flat" href="#!">Cancel</a>
                <a class="modal-action waves-effect waves-green btn-flat" onclick="updateTag()">Save</a>
            </div>
        </div>

        <!--Import jQuery before materialize.js-->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.1/js/materialize.min.js"></script>
        <script>

            var mTags;
            var mCurrentTagUsers;

            // Page-specific init
            function init() {
                refreshTags();
            }

            function refreshTags() {
                var query = new Parse.Query("Categories");
                query.ascending("name");
                query.find().then(function(tags) {
                    displayTags(tags);
                });
            }

            function displayTags(tags) {

                // Dynamically load cards
                var tagList = document.getElementById("tag_list");
                mTags = tags;
                $.each(
                    tags,
                    function(i, tag) {

                        var col = document.createElement("div");
                        tagList.appendChild(col);
                        col.className = "col s12 m6 l3";

                        var item = document.createElement("div");
                        col.appendChild(item);
                        item.className = "card-panel hoverable waves-effect";
                        item.onclick = function() {
                            tagSelected(i);
                        }
                        item.style.width = "100%";

                        var name = document.createElement("span");
                        item.appendChild(name);
                        name.className = "card-title black-text";
                        name.innerHTML = tag.get("name");

                        var author = document.createElement("p");
                        item.appendChild(author);
                        author.innerHTML = "Author: " + tag.get("id_author");

                        var category = document.createElement("p");
                        item.appendChild(category);
                        category.innerHTML = "Category: " + tag.get("id_category");

                    }
                );

                // Set all cards to the same height
                var maxHeight = 0;
                $.each($('#tag_list').find('div[class^="card-panel"]'), function() {
                    if ($(this).height() > maxHeight) {
                        maxHeight = $(this).height();
                    }
                });
                $.each($('#tag_list').find('div[class^="card-panel"]'), function() {
                    $(this).height(maxHeight);
                });
            }

            function tagSelected(position) {
                mCurrentTagUsers = null;
                if (mTags) {
                    document.getElementById('update_tag_modal_title').innerHTML = mTags[position].get("name");
                    document.getElementById('users_in_tag').innerHTML = "";

                    var id_author = mTags[position].get("id_author");
                    var id_category = mTags[position].get("id_category");
                    var icon_img = mTags[position].get("icon_img");

                    id_author = id_author == "@null" ? "" : id_author;
                    id_category = id_category == "@null" ? "" : id_category;

                    document.getElementById('update_id_author_field').value = id_author;
                    document.getElementById('update_id_author_field_label').className = "";
                    if (id_author) {
                        document.getElementById('update_id_author_field_label').className = "active";
                    }

                    document.getElementById('update_id_category_field').value = id_category;
                    document.getElementById('update_id_category_field_label').className = "";
                    if (id_category) {
                        document.getElementById('update_id_category_field_label').className = "active";
                    }

                    document.getElementById('update_icon_img_field').value = icon_img;
                    document.getElementById('update_icon_img_field_label').className = "";
                    if (icon_img) {
                        document.getElementById('update_icon_img_field_label').className = "active";
                    }

                    populateTagModalUsersList(position);
                    $('#update_tag_modal').openModal();    
                }
            }

            function populateTagModalUsersList(position) {
                if (mTags) {
                    var params = {
                        tag: mTags[position].get("name")
                    };
                    Parse.Cloud.run('Tag_getUsers', params, {
                        success: function(users) {
                            mCurrentTagUsers = users.data;             
                            $.each(
                                mCurrentTagUsers,
                                function (i, user) {
                                    addUserToTagUsersList(user);
                                }
                            );
                        },
                        error: function(error) {
                            console.log("Error retrieving users for tag " + mTags[position].get("name") + ": " + error.code + ", " + error.message);
                        }
                    });
                }
            }

            function addUserToTag() {
                
                var newUserField = document.getElementById('add_user_to_club');
                var username = newUserField.value;

                var query = new Parse.Query(Parse.User);
                query.equalTo("username", username);
                query.first().then(function(user) {
                    if (user) {
                        addUserToTagUsersList(user);
                        newUserField.value = "";
                    } else {
                        console.log("Cannot find user " + username);
                    }
                });
            }

            function addUserToTagUsersList(user) {
                var list = document.getElementById('users_in_tag');
                                    
                var item = document.createElement("div");
                list.appendChild(item);
                item.id = "user_in_tag_" + user.id;
                item.className = "deletable-list-item";

                var left = document.createElement("p");
                item.appendChild(left);
                left.className = "align-left";
                left.innerHTML = user.getUsername();

                var right = document.createElement("p");
                item.appendChild(right);
                right.className = "align-right";

                var deleteButton = document.createElement("a");
                right.appendChild(deleteButton);
                deleteButton.className = "delete-button";
                deleteButton.href = "#";
                deleteButton.onclick = function() {
                    item.parentNode.removeChild(item);
                }
                deleteButton.innerHTML = "&#10006;";
            }

            function addTag() {

                var name = document.getElementById("name_field").value;
                var id_author = document.getElementById("id_author_field").value;
                var id_category = document.getElementById("id_category_field").value;
                var icon_img = document.getElementById("icon_img_field").value;

                var params = {
                    name: name,
                    id_author: id_author,
                    id_category: id_category,
                    icon_img: icon_img
                };

                Parse.Cloud.run('Tag_create', params, {
                    success: function(object) {
                        alert("Successfully saved tags");
                    },
                    error: function(error) {
                        alert("Error saving tags: " + error.code + ", " + error.message);
                    }
                });        
            }

            function updateTag() {

                var name = document.getElementById("update_tag_modal_title").innerHTML;
                var id_author = document.getElementById("update_id_author_field").value;
                var id_category = document.getElementById("update_id_category_field").value;
                var icon_img = document.getElementById("update_icon_img_field").value;

                var params = {
                    name: name,
                    id_author: id_author,
                    id_category: id_category,
                    icon_img: icon_img
                };

                Parse.Cloud.run('Tag_update', params, {
                    success: function(object) {
                        alert("Successfully updated tags");
                    },
                    error: function(error) {
                        alert("Error updating tags: " + error.code + ", " + error.message);
                    }
                });        
            }

            function exportTags() {
                
                var tags = {
                    tags: []
                }

                for (var i=0; i<mTags.length; i++) {
                    var tag = {
                        name: mTags[i].get("name"),
                        id: mTags[i].id
                    }
                    tags.tags.push(tag);
                }

                var jsonContent = JSON.stringify(tags);

                var link = document.createElement("a");
                link.download = "categories.json";
                link.href = "data:text/html," + jsonContent;
                link.click();
            }

        </script>
        <script src="js/common.js"></script>

    </body>
</html>
