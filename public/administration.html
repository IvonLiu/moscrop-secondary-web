<html>

    <head>
        <title>Moscrop Secondary | Admin</title>

        <!--Import materialize.css-->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.1/css/materialize.min.css">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

        <link type="text/css" rel="stylesheet" href="css/common.css"/>

        <!--Let browser know website is optimized for mobile-->
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

        <!-- Import Parse -->
        <script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.5.0.min.js"></script>
    </head>

    <body>
        
        <div id="navbar-container">
            <ul id="accountDropdownItems" class="dropdown-content">
                <li><a href="settings.html">Settings</a></li>
                <!--<li class="divider"></li>-->
                <li><a onclick="logout()">Logout</a></li>
            </ul>
            <div class="navbar-fixed" style="height:72px">
                <nav>
                    <div class="nav-wrapper" style="background-color:#4784c0; padding-left:16px; padding-right:16px">
                        <a href="index.html" class="brand-logo">Moscrop Secondary</a>
                        <div id="toolbarActions" class="hidden">
                            <ul id="loggedInActions" class="right hide-on-med-and-down">
                                <li id="username" style="background-color:#4784c0; margin-right:16px"></li>
                                <li id="submitButton"><a href="submit.html" class="tooltipped" data-position="bottom" data-delay="50" data-tooltip="Create new post"><i class="material-icons">create</i></a></li>
                                <li id="adminButton"><a href="administration.html" class="tooltipped" data-position="bottom" data-delay="50" data-tooltip="Administration"><i class="material-icons">lock</i></a></li>
                                <li id="accountDropdown"><a class="dropdown-button" href="#!" data-activates="accountDropdownItems"><i class="material-icons">account_circle</i></a></li>
                            </ul>
                            <ul id="loggedOutActions" class="right hide-on-med-and-down">
                                <li id="loginButton"><a href="login.html">Login</a></li>
                                <li id="registerButton"><a href="register.html">Register</a></li>
                            </ul>
                        </div>
                    </div>
                </nav>
            </div>

            <div id="request_access_modal" class="modal modal-fixed-footer">
                <div class="modal-content">
                    <h4>Request Access</h4>
                    <div class="row">
                        <form id="available_categories" class="col s12" action="#"></form>
                    </div>
                    <div class="row">
                        <div class="input-field col s12" onkeydown="if (event.keyCode == 13) addClub()">
                            <i class="material-icons prefix">add</i>
                            <input id="request_new_club" type="text" class="validate">
                            <label for="request_new_club">Request new club</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <a class="modal-action waves-effect waves-green btn-flat" onclick="sendAccessRequest()">Request</a>
                    <a class="modal-action modal-close waves-effect waves-green btn-flat" href="#!">Cancel</a>
                </div>
            </div>
        </div>

        <div class="container">

            <div id="superuserActions">
                <div class="row section">
                    <div class="col s12">
                        <h5>Superuser Actions</h5>
                    </div>
                    <form class="col s12">
                        <div class="row">    
                            <div class="input-field col s12">
                              <input id="admin_username_field" type="text" list="usernames" class="validate">
                              <label for="admin_username_field">Username</label>
                            </div>
                        </div>
                    </form>
                    <div class="col s12">
                        <a class="waves-effect waves-light btn" style="width:100%" onclick="addAdministrator()">Add Administrator</a>
                    </div>
                </div>

                <div class="divider"></div>
            </div>

            <div id="administratorActions">
                <div class="row section">
                    <div class="col s12">
                        <h5>Administrator Actions</h5>
                    </div>
                    <form class="col s12">
                        <div class="row">    
                            <div class="input-field col s12">
                              <input id="mod_username_field" type="text" list="usernames" class="validate">
                              <label for="mod_username_field">Username</label>
                            </div>
                        </div>
                    </form>
                    <div class="col s12">
                        <a class="waves-effect waves-light btn" style="width:100%" onclick="addModerator()">Add Moderator</a>
                    </div>
                </div>

                <div class="divider"></div>
            </div>

            <div id="moderatorActions">
                <div class="row section">
                    <div class="col s12">
                        <h5>Moderator Actions</h5>
                    </div>
                    <form class="col s12">
                        <div class="row">    
                            <div class="col s6">
                                <a class="waves-effect waves-light btn" style="width:100%" href="usermanager.html">User Manager</a>
                            </div>
                            <div class="col s6">
                                <a class="waves-effect waves-light btn" style="width:100%" href="tageditor.html">Tag Editor</a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

        </div>

        <!--Temporarirly hard-coded datalists for demo purposes, will be replaced with parse usernames and clubs requests-->
        <datalist id="usernames" class="input-field"></datalist>

        <datalist id="categories"></datalist>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.1/js/materialize.min.js"></script>
        <script>

            // Page-specific init
            function init() {

                // Populate usernames list
                var userQuery = new Parse.Query(Parse.User);
                userQuery.ascending("username");
                userQuery.find().then(function(users) {
                    $.each(
                        users,
                        function(i, user) {
                            var option = document.createElement("option");
                            option.value = user.getUsername();
                            document.getElementById("usernames").appendChild(option);
                        }
                    );
                });

                // Populate categories list
                var categoryQuery = new Parse.Query("Categories");
                categoryQuery.ascending("name");
                categoryQuery.find().then(function(categories) {
                    $.each(
                        categories,
                        function(i, category) {
                            var option = document.createElement("option");
                            option.value = category.get("name");
                            document.getElementById("categories").appendChild(option);
                        }
                    );
                });

                // Hide unauthorized actions
                if (currentUser.getUsername() != "Superuser") {
                    var divSuperuserActions = document.getElementById("superuserActions");
                    divSuperuserActions.style.display = "none";
                    if (mUserPermissionLevel != "administrator") {
                        var divAdministratorActions = document.getElementById("administratorActions");
                        divAdministratorActions.style.display = "none";
                        if (mUserPermissionLevel != "moderator") {
                            logout();
                            console.log("Logging out");
                            window.location.href = "login.html"
                        }
                    }
                }
            }

            function addAdministrator() {
                if (currentUser.getUsername() != "Superuser") {
                    alert("You do not have permission to add administrators.");
                    return;
                }

                var username = document.getElementById("admin_username_field").value;
                var roleName = "administrator";

                addUserToRole(username, roleName);
            }

            function addModerator() {
                if (currentUser.getUsername() != "Superuser") {
                    var roleQuery = new Parse.Query(Parse.Role);
                    roleQuery.equalTo("name", "administrator");
                    roleQuery.equalTo("users", Parse.User.current());
                    roleQuery.first().then(function(role) {
                        if (!role) {
                            alert("You do not have permission to add moderators.");
                            return;
                        }
                    });
                }

                var username = document.getElementById("mod_username_field").value;
                var roleName = "moderator";

                addUserToRole(username, roleName);
            }

            function addContributor() {
                params = {
                    username: currentUser.getUsername()
                };
                Parse.Cloud.run("User_getPermissionLevel", params, {
                    success: function(response) {
                        if (response.data == "administrator" || response.data == "moderator") {
                            var username = document.getElementById("contributor_username_field").value;
                            var roleName = document.getElementById("contributor_group_field").value;

                            params = {
                                username: username,
                                tag: roleName
                            };
                            Parse.Cloud.run("Tag_addUser", params, {
                                success: function(response) {
                                    alert("Success");
                                },
                                error: function(error) {
                                    // Ignore for now
                                }
                            });
                        } else {
                            alert("You do not have permission to add contributors.");
                        }
                    },
                    error: function(error) {
                        // Ignore for now
                    }
                });
            }

        </script>
        <script src="js/common.js"></script>
    </body>
</html>